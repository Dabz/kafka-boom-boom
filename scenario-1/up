#!/bin/bash

docker-compose down -v
docker-compose up -d 

KAFKA_1_IP=`docker-compose exec kafka-1 bash -c "hostname -I"`
KAFKA_2_IP=`docker-compose exec kafka-2 bash -c "hostname -I"`
KAFKA_3_IP=`docker-compose exec kafka-3 bash -c "hostname -I"`
ZOO_IP=`docker-compose exec zookeeper bash -c "hostname -I"`
interface=eth0

source ../utils/utils.sh 

main() {

	create_topic zookeeper test 3 1
	get_state zookeeper
	send_message kafka-1 'before partitions'
	read_message kafka-1

	log "Network partition  Kafka-1 | Kafka-2, Kafka-3,  Zookeeper "
	block_one_host kafka-1 $KAFKA_2_IP
	block_one_host kafka-1 $KAFKA_3_IP
	block_one_host kafka-1 $ZOO_IP

	send_message kafka-1 'should not be ok, the invalid leader'
	send_message kafka-3 'should be ok, the valid leader'

	get_state zookeeper

	log "Removing network partition"
	remove_partition zookeeper kafka-1 kafka-2 kafka-3

	sleep 15

	get_state zookeeper

	read_message kafka-1
	read_message kafka-3
}

main
